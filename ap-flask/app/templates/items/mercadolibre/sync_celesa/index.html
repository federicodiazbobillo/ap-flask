{# app/templates/items/mercadolibre/sync_celesa/index.html #}
{% extends "base.html" %}
{% block content %}

<h3 class="mb-3">Sync Celesa</h3>
<a href="{{ url_for('sync_celesa_bp.sale_terms_index') }}" class="btn btn-primary btn-sm">
  Parámetros de Sale Terms
</a>
<button id="btn_put_general"
        type="button"
        class="btn btn-success btn-sm ml-2"
       
        disabled>
  Actualizar en ML (PUT)
</button>
{# ======================= BARRA DE FILTROS COMPARTIDOS ======================= #}
<form id="sharedFiltersForm" method="get" action="{{ url_for('sync_celesa_bp.index') }}" class="mb-3">
  <input type="hidden" name="page" value="1">
  <input type="hidden" id="sharedTab" name="tab" value="{{ active_tab or 'general' }}">
  <div class="card">
    <div class="card-body py-2">
      <div class="d-flex flex-wrap align-items-center w-100">
        <strong class="mr-3">Filtrar por status:</strong>

        <div class="form-check form-check-inline mb-2">
          <input class="form-check-input" type="checkbox" id="st_null" name="status"
                 value="{{ NULL_SENTINEL }}"
                 {% if NULL_SENTINEL in selected_statuses %}checked{% endif %}>
          <label class="form-check-label" for="st_null">Sin status</label>
        </div>

        {% for s in available_statuses %}
          {% if s is not none and s != '' %}
            {% set _id = 'st_' ~ loop.index %}
            <div class="form-check form-check-inline mb-2">
              <input class="form-check-input" type="checkbox" id="{{ _id }}" name="status"
                     value="{{ s }}"
                     {% if s in selected_statuses %}checked{% endif %}>
              <label class="form-check-label" for="{{ _id }}">{{ s }}</label>
            </div>
          {% endif %}
        {% endfor %}

        <div class="ml-auto"></div>
      </div>

      <div class="mt-2 d-flex flex-wrap align-items-center">
        <strong class="mr-3">ISBN:</strong>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" id="isbn_all" name="isbn_ok" value=""
                 {% if not isbn_ok %}checked{% endif %}>
          <label class="form-check-label" for="isbn_all">Todos</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" id="isbn_valid" name="isbn_ok" value="valid"
                 {% if isbn_ok == 'valid' %}checked{% endif %}>
          <label class="form-check-label" for="isbn_valid">Solo válidos (13 dígitos)</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" id="isbn_invalid" name="isbn_ok" value="invalid"
                 {% if isbn_ok == 'invalid' %}checked{% endif %}>
          <label class="form-check-label" for="isbn_invalid">Solo inválidos</label>
        </div>

        <button type="submit" class="btn btn-primary btn-sm ml-3">Aplicar</button>
        <a class="btn btn-light btn-sm ml-2" href="{{ url_for('sync_celesa_bp.index', page=1, tab=(active_tab or 'general')) }}">Limpiar</a>
      </div>
    </div>
  </div>
</form>

{# --- NAV TABS --- #}
<ul class="nav nav-tabs" id="syncTabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link {% if (active_tab or 'general') != 'stock' %}active{% endif %}"
       id="tablink-general"
       data-toggle="tab"
       href="#tab-general"
       role="tab"
       aria-controls="tab-general"
       aria-selected="{{ ((active_tab or 'general') != 'stock') | string | lower }}"
       data-tab-target="general">
      Condiciones generales
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if active_tab == 'stock' %}active{% endif %}"
       id="tablink-stock"
       data-toggle="tab"
       href="#tab-stock"
       role="tab"
       aria-controls="tab-stock"
       aria-selected="{{ (active_tab == 'stock') | string | lower }}"
       data-tab-target="stock">
      Manejo de stock
    </a>
  </li>
</ul>

<div class="tab-content mt-3">
  {# ======================= TAB: GENERALES ======================= #}
  <div class="tab-pane fade {% if (active_tab or 'general') != 'stock' %}show active{% endif %}" id="tab-general" role="tabpanel" aria-labelledby="tablink-general">

    {# -- Acciones (async con modal) -- #}
    <div class="mb-3">
      <label class="mr-2 mb-0 small text-muted">Batch:</label>
      <input id="batchSize" type="number" value="100" min="10" max="1000"
             class="form-control form-control-sm d-inline-block" style="width:90px;">

      <div class="form-check form-check-inline ml-3">
        <input class="form-check-input" type="checkbox" id="processAll">
        <label class="form-check-label" for="processAll">Procesar TODO</label>
      </div>

      <input id="maxItems" type="hidden" value="5000">

      <button type="button"
              id="btnNormalizeApi"
              class="btn btn-warning btn-sm ml-3"
              data-start-url="{{ url_for('sync_celesa_bp.normalize_start') }}">
        Verificar ISBN (API)
      </button>

      <button type="button"
              id="btnVerifyApi"
              class="btn btn-secondary btn-sm ml-1"
              data-start-url="{{ url_for('sync_celesa_bp.verify_start') }}">
        Verificar status (API)
      </button>

      <a class="btn btn-info btn-sm ml-3"
         href="{{ url_for('sync_celesa_bp.index',
                          page=1, status=selected_statuses, isbn_ok=isbn_ok, analyze=1, tab='general') }}">
        Analizar ISBN
      </a>
    </div>

    {% if analyze %}
      <div class="alert alert-secondary py-2 mb-3">
        <strong>Análisis ISBN (con filtros actuales):</strong>
        <span class="badge badge-success ml-2">Válidos: {{ isbn_ok_count }}</span>
        <span class="badge badge-danger ml-2">Inválidos: {{ isbn_bad_count }}</span>
        <span class="badge badge-dark ml-2">Total: {{ total }}</span>
      </div>
    {% endif %}

    <p class="text-muted mb-2">
      Mostrando {{ start }}–{{ end }} de {{ total }} registros • {{ page_size }} por página
      {% if selected_statuses and selected_statuses|length > 0 %}
        • Status:
        {% for s in selected_statuses %}
          <span class="badge badge-info">{{ 'Sin status' if s == NULL_SENTINEL else s }}</span>
        {% endfor %}
      {% endif %}
      {% if isbn_ok %}
        • ISBN: <span class="badge badge-info">{{ 'Válidos' if isbn_ok=='valid' else 'Inválidos' }}</span>
      {% endif %}
      {% if stock_filter == 'celesa_zero_ml_positive' %}
        • Stock: <span class="badge badge-warning">Celesa = 0 y ML ≥ 1</span>
        <a class="btn btn-link btn-sm ml-1"
           href="{{ url_for('sync_celesa_bp.index', page=1, status=selected_statuses, isbn_ok=isbn_ok, tab='general') }}">
          Quitar filtro de stock
        </a>
      {% elif stock_filter == 'celesa_positive_ml_zero' %}
        • Stock: <span class="badge badge-warning">Celesa &gt; 0 y ML = 0</span>
        <a class="btn btn-link btn-sm ml-1"
           href="{{ url_for('sync_celesa_bp.index', page=1, status=selected_statuses, isbn_ok=isbn_ok, tab='general') }}">
          Quitar filtro de stock
        </a>
      {% elif stock_filter == 'celesa_diff' %}
        • Stock: <span class="badge badge-warning">Celesa ≠ ML</span>
        <a class="btn btn-link btn-sm ml-1"
           href="{{ url_for('sync_celesa_bp.index', page=1, status=selected_statuses, isbn_ok=isbn_ok, tab='general') }}">
          Quitar filtro de stock
        </a>
      {% endif %}
    </p>

    {# --- Selección masiva (global) --- #}
    <div class="mb-3 d-flex flex-wrap align-items-center">
      <div class="form-check mr-3">
        <input class="form-check-input" type="checkbox" id="check_all_results">
        <label class="form-check-label" for="check_all_results">
          Seleccionar <strong>TODOS</strong> los resultados del filtro ({{ total }})
        </label>
      </div>
      <button id="btn_mass_action" class="btn btn-sm btn-primary ml-2" type="button" disabled>
        Continuar con acción masiva
      </button>
      <span id="sel_hint" class="text-muted ml-3" style="display:none;">
        Se aplicará sobre <strong>todos</strong> los {{ total }} resultados filtrados.
      </span>
    </div>

    <div class="table-responsive">
      <table class="table table-sm table-bordered table-hover">
        <thead class="thead-light">
          <tr>
            <th style="width:36px;">
              <input type="checkbox" id="check_all_page_general" data-scope="general">
            </th>
            <th style="white-space:nowrap;">IDML</th>
            <th>ISBN</th>
            <th>Status</th>
            <th style="white-space:nowrap;">Stock IDML</th>
            <th style="white-space:nowrap;">Stock Celesa</th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
            {% for r in rows %}
              {% set _idml = r[0] %}
              <tr>
                <td class="text-center align-middle">
                  {% if _idml %}
                    <input type="checkbox"
                           class="row-check row-check-general"
                           data-scope="general"
                           data-idml="{{ _idml }}"
                           value="{{ _idml }}">
                  {% endif %}
                </td>
                <td class="text-monospace">
                  {% if _idml %}
                    <a class="idml-link"
                       data-idml="{{ _idml }}"
                       href="https://api.mercadolibre.com/items/{{ _idml }}"
                       target="_blank" rel="noopener noreferrer">{{ _idml }}</a>
                  {% else %}
                    {{ _idml or '' }}
                  {% endif %}
                </td>
                <td class="text-monospace">{{ r[1] or '' }}</td>
                <td>{{ r[2] or '' }}</td>
                <td>{{ r[3] if r[3] is not none else '' }}</td>
                <td>{{ r[4] if r[4] is not none else '' }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6" class="text-center text-muted">Sin resultados</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <nav aria-label="Paginación">
      <ul class="pagination">
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
          <a class="page-link"
             href="{{ url_for('sync_celesa_bp.index', page=1, status=selected_statuses, isbn_ok=isbn_ok, tab='general') }}">« Primero</a>
        </li>
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
          <a class="page-link"
             href="{{ url_for('sync_celesa_bp.index', page=(page-1 if page>1 else 1), status=selected_statuses, isbn_ok=isbn_ok, tab='general') }}">‹ Anterior</a>
        </li>
        <li class="page-item disabled">
          <span class="page-link">Página {{ page }} de {{ total_pages }}</span>
        </li>
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
          <a class="page-link"
             href="{{ url_for('sync_celesa_bp.index', page=(page+1 if page<total_pages else total_pages), status=selected_statuses, isbn_ok=isbn_ok, tab='general') }}">Siguiente ›</a>
        </li>
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
          <a class="page-link"
             href="{{ url_for('sync_celesa_bp.index', page=total_pages, status=selected_statuses, isbn_ok=isbn_ok, tab='general') }}">Última »</a>
        </li>
      </ul>
    </nav>
  </div>

  {# ======================= TAB: STOCK ======================= #}
  <div class="tab-pane fade {% if active_tab == 'stock' %}show active{% endif %}" id="tab-stock" role="tabpanel" aria-labelledby="tablink-stock">

    <div class="card mb-3">
      <div class="card-body">
        <h6 class="mb-3">Manejo de stock</h6>

        <div class="btn-group" role="group" aria-label="Filtros de stock">
          <a class="btn btn-outline-primary btn-sm {% if stock_filter == 'celesa_zero_ml_positive' %}active{% endif %}"
             href="{{ url_for('sync_celesa_bp.index', page=1, tab='stock', status=selected_statuses, isbn_ok=isbn_ok, stock_filter='celesa_zero_ml_positive') }}">
            Celesa = 0 y ML ≥ 1
          </a>
        </div>

        <div class="btn-group ml-1" role="group" aria-label="Filtros de stock 2">
          <a class="btn btn-outline-primary btn-sm {% if stock_filter == 'celesa_positive_ml_zero' %}active{% endif %}"
             href="{{ url_for('sync_celesa_bp.index', page=1, tab='stock', status=selected_statuses, isbn_ok=isbn_ok, stock_filter='celesa_positive_ml_zero') }}">
            Celesa &gt; 0 y ML = 0
          </a>
          <a class="btn btn-outline-primary btn-sm {% if stock_filter == 'celesa_diff' %}active{% endif %}"
             href="{{ url_for('sync_celesa_bp.index', page=1, tab='stock', status=selected_statuses, isbn_ok=isbn_ok, stock_filter='celesa_diff') }}">
            Celesa ≠ ML
          </a>
        </div>

        {% if stock_filter %}
          <a class="btn btn-link btn-sm ml-2"
             href="{{ url_for('sync_celesa_bp.index', page=1, status=selected_statuses, isbn_ok=isbn_ok, tab='stock') }}">
            Quitar filtro
          </a>
        {% endif %}

        <small class="text-muted d-block mt-2">
          Elegí un filtro de stock (funcionan como opciones exclusivas).
        </small>
      </div>
    </div>

    <p class="text-muted mb-2">
      Mostrando {{ start }}–{{ end }} de {{ total }} registros • {{ page_size }} por página
      {% if stock_filter == 'celesa_zero_ml_positive' %}
        • Stock: <span class="badge badge-warning">Celesa = 0 y ML ≥ 1</span>
      {% elif stock_filter == 'celesa_positive_ml_zero' %}
        • Stock: <span class="badge badge-warning">Celesa &gt; 0 y ML = 0</span>
      {% elif stock_filter == 'celesa_diff' %}
        • Stock: <span class="badge badge-warning">Celesa ≠ ML</span>
      {% endif %}
    </p>

    <div class="table-responsive">
      <table class="table table-sm table-bordered table-hover">
        <thead class="thead-light">
          <tr>
            <th style="width:36px;">
              <input type="checkbox" id="check_all_page_stock" data-scope="stock">
            </th>
            <th style="white-space:nowrap;">IDML</th>
            <th>ISBN</th>
            <th>Status</th>
            <th style="white-space:nowrap;">Stock IDML</th>
            <th style="white-space:nowrap;">Stock Celesa</th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
            {% for r in rows %}
              {% set _idml = r[0] %}
              <tr>
                <td class="text-center align-middle">
                  {% if _idml %}
                    <input type="checkbox"
                           class="row-check row-check-stock"
                           data-scope="stock"
                           data-idml="{{ _idml }}"
                           value="{{ _idml }}">
                  {% endif %}
                </td>
                <td class="text-monospace">{{ _idml or '' }}</td>
                <td class="text-monospace">{{ r[1] or '' }}</td>
                <td>{{ r[2] or '' }}</td>
                <td>{{ r[3] if r[3] is not none else '' }}</td>
                <td>{{ r[4] if r[4] is not none else '' }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6" class="text-center text-muted">Sin resultados</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <nav aria-label="Paginación">
      <ul class="pagination">
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
          <a class="page-link"
             href="{{ url_for('sync_celesa_bp.index', page=1, status=selected_statuses, isbn_ok=isbn_ok, tab='stock') }}">« Primero</a>
        </li>
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
          <a class="page-link"
             href="{{ url_for('sync_celesa_bp.index', page=(page-1 if page>1 else 1), status=selected_statuses, isbn_ok=isbn_ok, tab='stock') }}">‹ Anterior</a>
        </li>
        <li class="page-item disabled">
          <span class="page-link">Página {{ page }} de {{ total_pages }}</span>
        </li>
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
          <a class="page-link"
             href="{{ url_for('sync_celesa_bp.index', page=(page+1 if page<total_pages else total_pages), status=selected_statuses, isbn_ok=isbn_ok, tab='stock') }}">Siguiente ›</a>
        </li>
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
          <a class="page-link"
             href="{{ url_for('sync_celesa_bp.index', page=total_pages, status=selected_statuses, isbn_ok=isbn_ok, tab='stock') }}">Última »</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- Filtros actuales (para JS) -->
<input type="hidden" id="filter_statuses" value="{{ (selected_statuses or []) | join(',') }}">
<input type="hidden" id="filter_isbn_ok" value="{{ isbn_ok or '' }}">
<input type="hidden" id="activeTab" value="{{ active_tab or 'general' }}">
<input type="hidden" id="sel_total" value="{{ total }}"> {# usado por el hint del checkbox global #}

<!-- Plantilla de URL para consultar estado del job -->
<div id="jobConfig"
     data-status-template="{{ url_for('sync_celesa_bp.job_status', job_id='__JOB__') }}"></div>

<!-- Modal de progreso (reutilizado para todas las acciones) -->
<div class="modal fade" id="jobModal" tabindex="-1" role="dialog"
     aria-labelledby="jobModalLabel" aria-hidden="true"
     data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-md modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="jobModalLabel">Procesando…</h5>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center mb-2">
          <div class="spinner-border mr-2" role="status" aria-hidden="true"></div>
          <div>
            <div id="jobCounts" class="small text-muted">0 / 0</div>
            <div class="small">Último: <code id="jobLastIdml">-</code> • Código: <span id="jobLastCode">-</span></div>
          </div>
        </div>
        <div class="progress">
          <div id="jobProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
               role="progressbar" style="width: 0%;">0%</div>
        </div>
        <div id="jobAlert" class="alert alert-danger mt-3 d-none"></div>
      </div>
      <div class="modal-footer">
        <button id="jobCloseBtn" type="button" class="btn btn-secondary btn-sm" data-dismiss="modal" disabled>Cerrar</button>
      </div>
    </div>
  </div>
</div>

{# Mantener ?tab= en la URL al cambiar de pestaña y al enviar el form compartido #}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var tabs = document.querySelectorAll('#syncTabs a[data-tab-target]');
    var sharedForm = document.getElementById('sharedFiltersForm');
    var sharedTabInput = document.getElementById('sharedTab');

    function currentTab() {
      var active = document.querySelector('#syncTabs .nav-link.active[data-tab-target]');
      return active ? active.getAttribute('data-tab-target') : (document.getElementById('activeTab')?.value || 'general');
    }
    function syncSharedTab() {
      if (sharedTabInput) sharedTabInput.value = currentTab();
    }

    syncSharedTab();
    tabs.forEach(function (a) {
      a.addEventListener('shown.bs.tab', function (e) {
        var tab = e.target.getAttribute('data-tab-target') || 'general';
        var url = new URL(window.location.href);
        url.searchParams.set('tab', tab);
        window.history.replaceState({}, '', url.toString());
        syncSharedTab();
      });
    });
    if (sharedForm) {
      sharedForm.addEventListener('submit', function () { syncSharedTab(); });
    }
  });
</script>

{# cache-busting: subí el número si actualizás el JS #}
<script src="{{ url_for('static', filename='js/items/mercadolibre/sync_celesa.js', v=15) }}"></script>
{% endblock %}
