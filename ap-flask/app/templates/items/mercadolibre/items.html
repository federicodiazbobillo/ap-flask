{% extends 'base.html' %}

{% block content %}
<h4 class="mb-4">Items Mercado Libre</h4>

<form method="get" class="row g-3 mb-4">
  <div class="col-md-6">
    <label class="form-label">Tags</label><br>
    {% set selected_tags = request.args.getlist('tags') %}
    {% for tag in ['moderation_penalty', 'poor_quality_picture', 'out_of_stock'] %}
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="tags" value="{{ tag }}" id="tag_{{ tag }}"
               {% if tag in selected_tags %}checked{% endif %}>
        <label class="form-check-label" for="tag_{{ tag }}">{{ tag.replace('_', ' ') }}</label>
      </div>
    {% endfor %}
  </div>
    <div class="col-md-2">
    <label for="status" class="form-label">Estado</label>
    <select name="status" id="status" class="form-select">
        <option value="">Todos</option>
        {% for s in ['active', 'under_review', 'paused', 'closed'] %}
        <option value="{{ s }}" {% if request.args.get('status') == s %}selected{% endif %}>
            {{ s.replace('_', ' ').capitalize() }}
        </option>
        {% endfor %}
    </select>
    </div>
    <div class="col-md-4">
  <label class="form-label d-block">Validación</label>

  {% set selected_validado = request.args.get('validado') %}
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="validado" id="val_all" value="" 
           {% if selected_validado == None or selected_validado == '' %}checked{% endif %}>
    <label class="form-check-label" for="val_all">Todos</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="validado" id="val_0" value="0" 
           {% if selected_validado == '0' %}checked{% endif %}>
    <label class="form-check-label" for="val_0">Sin validar</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="validado" id="val_1" value="1" 
           {% if selected_validado == '1' %}checked{% endif %}>
    <label class="form-check-label" for="val_1">Validados</label>
  </div>
</div>

<div class="col-md-2">
  <label for="limit" class="form-label">Resultados por página</label>
  <select name="limit" id="limit" class="form-select">
    {% for opt in [1, 2, 5, 10, 50, 100, 500, 1000] %}
      <option value="{{ opt }}" {% if limit == opt %}selected{% endif %}>{{ opt }}</option>
    {% endfor %}
  </select>
</div>

  <div class="col-md-2 align-self-end">
    <button type="submit" class="btn btn-primary">Filtrar</button>
  </div>
</form>

{% if items %}
<p class="text-muted">Resultados encontrados: {{ total }}</p>
<form method="post" action="{{ url_for('catalogador_bp.catalogar_items') }}">
<table class="table table-striped table-bordered align-middle">
 <thead>
  <tr>
    <th><input type="checkbox" id="check_all" checked></th>  
    <th>IDML</th>
    <th>ISBN</th>
    <th>Título</th>
    <th>Imagen actual</th>
    <th>Imagen catálogo</th>
    <th>Validado</th> 
  </tr>
</thead>
<tbody>
  {% for item in items %}
  <tr>
    <td>

{% if item.catalogable %}
  {% if item.datos_contacto %}
    <span class="text-danger fw-bold" title="No se puede catalogar: IA detectó datos de contacto en la imagen">🚫</span>
  {% elif item.contacto_detectado_textual %}
    <span class="text-danger fw-bold" title="No se puede catalogar: texto contiene datos de contacto">🚫</span>
  {% elif item.bloqueado_catalogo %}
    <span class="text-warning fw-bold" title="No se puede catalogar: múltiples hijos o ninguno activo">🚫</span>
  {% else %}
    <input type="checkbox"
           name="selected_items"
           value="{{ item.idml }}"
           checked>
    <input type="hidden" name="catalog_product_id_{{ item.idml }}" value="{{ item.catalog_product_id }}">
  {% endif %}
{% else %}
  <span class="text-muted" title="No es catalogable">🚫</span>
{% endif %}

    </td>
    
    <td>
      <a href="https://www.mercadolibre.com.mx/publicaciones/listado?search={{ item.idml }}"
         target="_blank" rel="noopener noreferrer">
        {{ item.idml }}
      </a>
    </td>      
    <td>{{ item.isbn }}</td>
    <td>{{ item.title or '-' }}</td>
    <td>
        {% if item.thumbnail %}
            <a href="{{ item.permalink }}" target="_blank" title="Ver publicación en Mercado Libre">
            <img src="{{ item.thumbnail }}" alt="Imagen actual"
                class="img-thumbnail" style="max-height: 100px;">
            </a>
        {% else %}
            <span class="text-muted">Sin imagen</span>
        {% endif %}
    </td>

    <td>
        {% if item.catalog_image and item.catalog_image != 'varios' %}
            <a href="{{ item.catalog_image }}" target="_blank" title="Ver imagen catálogo">
            <img src="{{ item.catalog_image }}" alt="Imagen catálogo"
                class="img-thumbnail" style="max-height: 100px;">
            </a>
        {% elif item.catalog_image == 'varios' %}
            <span class="badge bg-warning text-dark">Varios registros</span>
        {% else %}
            <span class="text-muted">Sin imagen</span>
        {% endif %}
    </td>
    <td>
    {% if item.validado_ia_ahora %}
        <span class="text-success fw-bold" title="Validado recién con IA">✔️ IA (nuevo)</span>
    {% elif item.validado == 1 %}
        ✅
    {% elif item.validado == 2 %}
        <span class="text-success" title="Validado por IA, sin datos de contacto">✔️ IA</span>
    {% elif item.validado == 0 and item.datos_contacto %}
        <span class="text-danger fw-bold" title="🚫 IA detectó datos de contacto en la imagen">🚫 Revisión</span>
    {% else %}
        <span class="text-muted">No</span>
    {% endif %}
    </td>


  </tr>
  {% endfor %}
</tbody>


</table>
<button type="submit" class="btn btn-success mt-2">Catalogar seleccionados</button>
</form>
{% set args = request.args.to_dict(flat=False) %}
{% set _ = args.pop('limit', None) %}
{% set _ = args.pop('page', None) %}

<div class="d-flex justify-content-between align-items-center">
  <span>Mostrando página {{ page }} de {{ (total // limit) + (1 if total % limit else 0) }}</span>

  <nav>
    <ul class="pagination mb-0">
      {% if page > 1 %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('catalogador_bp.items', page=page-1, limit=limit, **args) }}">Anterior</a>
      </li>
      {% endif %}
      {% if (page * limit) < total %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('catalogador_bp.items', page=page+1, limit=limit, **args) }}">Siguiente</a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>
{% else %}
<div class="alert alert-info">No se encontraron resultados con los filtros actuales.</div>
{% endif %}


<script>
  const checkAll = document.getElementById('check_all');
  if (checkAll) {
    checkAll.addEventListener('change', function () {
      const checkboxes = document.querySelectorAll('input[name="selected_items"]');
      checkboxes.forEach(cb => cb.checked = this.checked);
    });
  }
</script>

{% endblock %}
