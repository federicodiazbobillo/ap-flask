{% extends 'base.html' %}

{% block content %}
<h1 class="mb-4">Items Mercado Libre</h1>

<form method="get" class="row g-3 mb-4">
  <div class="col-md-6">
    <label class="form-label">Tags</label><br>
    {% set selected_tags = request.args.getlist('tags') %}
    {% for tag in ['moderation_penalty', 'poor_quality_picture', 'out_of_stock', 'catalog_listing_eligible'] %}
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="tags" value="{{ tag }}" id="tag_{{ tag }}"
               {% if tag in selected_tags %}checked{% endif %}>
        <label class="form-check-label" for="tag_{{ tag }}">{{ tag.replace('_', ' ') }}</label>
      </div>
    {% endfor %}
  </div>

  <div class="col-md-2">
    <label for="limit" class="form-label">Resultados por página</label>
    <select name="limit" id="limit" class="form-select">
      <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
      <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
    </select>
  </div>

  <div class="col-md-2 align-self-end">
    <button type="submit" class="btn btn-primary">Filtrar</button>
  </div>
</form>

{% if items %}
<p class="text-muted">Resultados encontrados: {{ total }}</p>

<table class="table table-striped table-bordered align-middle">
  <thead>
    <tr>
      <th>IDML</th>
      <th>ISBN</th>
      <th>Título</th>
      <th>Imagen actual</th>
      <th>Imagen catálogo</th>
    </tr>
  </thead>
  <tbody>
    {% for item in items %}
    <tr>
      <td>{{ item.idml }}</td>
      <td>{{ item.isbn }}</td>
      <td>{{ item.title or '-' }}</td>
      <td>
        {% if item.thumbnail %}
        <img src="{{ item.thumbnail }}" alt="Imagen actual" class="img-thumbnail" style="max-height: 100px;">
        {% else %}
        <span class="text-muted">Sin imagen</span>
        {% endif %}
      </td>
      <td>
        {% if item.catalog_image %}
        <img src="{{ item.catalog_image }}" alt="Imagen catálogo" class="img-thumbnail" style="max-height: 100px;">
        {% else %}
        <span class="text-muted">Sin imagen</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% set args = request.args.to_dict(flat=False) %}
{% set _ = args.pop('limit', None) %}
{% set _ = args.pop('page', None) %}

<div class="d-flex justify-content-between align-items-center">
  <span>Mostrando página {{ page }} de {{ (total // limit) + (1 if total % limit else 0) }}</span>

  <nav>
    <ul class="pagination mb-0">
      {% if page > 1 %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('items_meli_bp.items', page=page-1, limit=limit, **args) }}">Anterior</a>
      </li>
      {% endif %}
      {% if (page * limit) < total %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('items_meli_bp.items', page=page+1, limit=limit, **args) }}">Siguiente</a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>
{% else %}
<div class="alert alert-info">No se encontraron resultados con los filtros actuales.</div>
{% endif %}

{% endblock %}
