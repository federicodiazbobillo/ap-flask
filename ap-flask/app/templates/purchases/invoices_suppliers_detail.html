{% extends "base.html" %}
{% block content %}
<h3>Detalle de Factura: {{ nro_fc }}</h3>

<form method="post" action="{{ url_for('invoices_suppliers_detail.actualizar_tc_factura') }}" class="form-inline mb-3">
  <input type="hidden" name="nro_fc" value="{{ nro_fc }}">
  <label for="tc" class="mr-2"><strong>Tipo de cambio:</strong></label>
  <input type="number" id="tc" name="tc" value="{{ tc or '' }}" step="0.0001"
       class="form-control form-control-sm mr-2" style="width: 120px;">
  <button type="submit" class="btn btn-sm btn-success">Actualizar</button>
</form>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Proveedor</th>
      <th>ISBN</th>
      <th>Importe</th>
      <th>Order ID</th>
      <th>Tipo</th>
      <th class="align-middle">
        Rayo
        <button
          type="button"
          class="btn btn-sm btn-outline-primary ml-1"
          id="btn-abrir-crear-rayo"
          data-toggle="modal"
          data-target="#modalCrearRayo"
          title="Crear en Rayo">
          Crear
        </button>
      </th>
      <th>Acción</th>
    </tr>
  </thead>
  <tbody>
    {% for row in items %}
    <tr>
      <td>{{ row[1].strftime('%d-%m-%Y') if row[1] else '' }}</td>
      <td>{{ row[2] }}</td>
      <td>{{ row[3] }}</td>
      <td>{{ row[4] }}</td>
      <td>
        {% if row[5] %}
          <form method="post" action="{{ url_for('invoices_suppliers_detail.desvincular_orden') }}" style="display:inline;">
            <input type="hidden" name="item_id" value="{{ row[0] }}">
            <span>#{{ row[5] }}</span>
            <button type="submit" class="btn btn-sm btn-outline-danger ml-1" title="Quitar vínculo" onclick="return confirm('¿Desvincular esta orden?')">×</button>
          </form>
        {% else %}
          -
        {% endif %}
      </td>
      <td>{{ row[6] }}</td>
      <td>
        {% if row[8] == 1 %}
          <span class="badge badge-success">Sí</span>
        {% else %}
          <span class="badge badge-secondary">No</span>
        {% endif %}
      </td>
      <td>
        {% if not row[5] %}
          <button class="btn btn-sm btn-info vincular-btn" data-item-id="{{ row[0] }}" data-isbn="{{ row[3]|e }}">Vincular orden</button>
        {% else %}
          —
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Modal: Productos faltantes en Rayo -->
<div class="modal fade" id="modalCrearRayo" tabindex="-1" role="dialog" aria-labelledby="modalCrearRayoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCrearRayoLabel">Productos faltantes en Rayo</h5>
        <button type="button" class="close" data-dismiss="modal" data-bs-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalCrearRayoBody">
        <p class="text-muted mb-0">Cargando…</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Vincular orden (el que fallaba) -->
<div class="modal fade" id="modalOrdenes" tabindex="-1" role="dialog" aria-labelledby="modalOrdenesLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalOrdenesLabel">Vincular orden</h5>
        <button type="button" class="close" data-dismiss="modal" data-bs-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalContenido">
        <p class="text-muted mb-0">Cargando…</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== Modal faltantes (Crear en Rayo): carga + títulos + portada =====
  (function () {
    const nroFc = "{{ nro_fc }}";
    const btn = document.getElementById("btn-abrir-crear-rayo");
    const body = document.getElementById("modalCrearRayoBody");

    // helper local: límite de concurrencia para pedir títulos
    function fetchTitlesWithLimit(pairs, limit = 8) {
      let i = 0, active = 0;
      return new Promise(resolve => {
        function next() {
          if (i >= pairs.length && active === 0) return resolve();
          while (active < limit && i < pairs.length) {
            const [cell, code, tr] = pairs[i++];  // cell: <td>, code: isbn/sku_norm, tr: <tr>
            active++;
            fetch(`/purchases/invoices_suppliers/detail/titulo/${encodeURIComponent(code)}`)
              .then(r => r.ok ? r.json() : null)
              .then(d => {
                const title = d && typeof d.title === 'string' && d.title.trim()
                  ? d.title.trim()
                  : '—';
                cell.textContent = title;
                if (tr) tr.dataset.title = (title === '—' ? '' : title);  // guardamos el título
              })
              .catch(() => {
                cell.innerHTML = '<span class="text-muted">—</span>';
                if (tr) tr.dataset.title = '';
              })
              .finally(() => { active--; next(); });
          }
        }
        next();
      });
    }

    // inicializa portadas con fallback .JPG -> .jpg -> texto "—"
function initCovers(rootEl) {
  const NO_IMAGE_URL = 'http://159.65.186.41/img/prod_sin_imagen.jpg';

  const imgs = rootEl.querySelectorAll('img[data-ce-cover]');
  imgs.forEach(img => {
    const upper = img.getAttribute('data-upper') || '';
    const lower = img.getAttribute('data-lower') || '';

    // Estado simple para evitar loops
    img.dataset.state = 'init';

    function handleError() {
        const st = img.dataset.state;

        if (st === 'init' && lower) {
          // Falló .JPG => probamos .jpg
          img.dataset.state = 'tried-lower';
          img.src = lower;
          return;
        }

        // Falló .jpg o no había lower => placeholder
        img.dataset.state = 'placeholder';
        img.onerror = null; // cortamos la cadena de errores
        img.src = NO_IMAGE_URL;
      }

      img.onerror = handleError;

      // Disparo inicial: si hay upper lo probamos, si no vamos directo a lower/placeholder
      if (upper) {
        img.src = upper;
      } else if (lower) {
        img.dataset.state = 'tried-lower';
        img.src = lower;
      } else {
        img.dataset.state = 'placeholder';
        img.onerror = null;
        img.src = NO_IMAGE_URL;
      }
    });
  }

    if (btn) {
      btn.addEventListener("click", function () {
        body.innerHTML = '<p class="text-muted mb-0">Cargando…</p>';
        fetch(`/purchases/invoices_suppliers/detail/faltantes/${encodeURIComponent(nroFc)}`)
          .then(r => r.json())
          .then(({ total, items }) => {
            if (!total) {
              body.innerHTML = `
                <div class="alert alert-success mb-0">
                  No hay productos faltantes en Rayo para esta factura.
                </div>`;
              return;
            }

            // Construcción de filas: ISBN/SKU + Título + Portada
            const rows = items.map((it, idx) => {
              const raw = String(it.isbn ?? '').trim();
              const digits = raw.replace(/\D+/g, '');
              const prefer = (it.sku_norm && /^\d+$/.test(it.sku_norm)) ? it.sku_norm : digits;

              // Portada: subcarpeta = primeros 7 dígitos; nombre = ISBN sin el último dígito
              let coverCell = '<span class="text-muted">—</span>';
              if (/^\d{10,}$/.test(prefer)) {
                const sub = prefer.slice(0, 7);
                const name = prefer.slice(0, -1);
                const upper = `https://www.celesa.com/imagenes/${sub}/${name}.JPG`;
                const lower = `https://www.celesa.com/imagenes/${sub}/${name}.jpg`;
                coverCell = `<img data-ce-cover data-upper="${upper}"  data-lower="${lower}"  loading="lazy" alt="Portada" style="max-height:64px">`;
              }

              return `
                <tr id="r-${idx}" data-isbn="${raw}" data-code="${prefer}" data-title="">
                  <td><code>${raw}</code></td>
                  <td class="col-titulo"><span class="text-muted">Buscando…</span></td>
                  <td class="col-cover">${coverCell}</td>
                </tr>`;
            }).join("");

            body.innerHTML = `
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div><strong>Faltantes (agrupados por SKU):</strong> ${total}</div>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-striped mb-0">
                  <thead>
                    <tr>
                      <th>ISBN/SKU</th>
                      <th>Título</th>
                      <th>Portada</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>`;

            // Completar títulos con límite de concurrencia
            const tbody = body.querySelector('tbody');
            const pairs = Array.from(tbody.querySelectorAll('tr[data-code]')).map((tr) => {
              const cell = tr.querySelector('.col-titulo');
              const code = tr.getAttribute('data-code') || '';
              return [cell, code, tr];
            });
            fetchTitlesWithLimit(pairs, 8);

            // Inicializar portadas (JPG -> jpg -> “—”)
            initCovers(body);
          })
          .catch(() => {
            body.innerHTML = `<div class="alert alert-danger mb-0">Error al cargar los faltantes.</div>`;
          });
      });
    }
  })();

  // ===== Util: mostrar modal compatible (BS4 y BS5) =====
  function showModalOrdenes() {
    const el = document.getElementById('modalOrdenes');

    // Bootstrap 5
    if (window.bootstrap && bootstrap.Modal) {
      let modal;
      if (typeof bootstrap.Modal.getOrCreateInstance === 'function') {
        modal = bootstrap.Modal.getOrCreateInstance(el);
      } else if (typeof bootstrap.Modal.getInstance === 'function') {
        modal = bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el);
      } else {
        modal = new bootstrap.Modal(el);
      }
      modal.show();
      return;
    }

    // Bootstrap 4 (jQuery)
    if (window.jQuery && $('#modalOrdenes').modal) {
      $('#modalOrdenes').modal('show');
      return;
    }

    // Fallback (sin Bootstrap)
    el.classList.add('show');
    el.style.display = 'block';
    el.removeAttribute('aria-hidden');
    document.body.classList.add('modal-open');
  }

  // ===== Modal vincular orden (sin cambios) =====
  function abrirModal(itemId, isbn) {
    const cont = document.getElementById("modalContenido");
    if (cont) cont.innerHTML = '<p class="text-muted mb-0">Cargando…</p>';

    fetch("/purchases/invoices_suppliers/detail/buscar_ordenes_por_isbn", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ isbn })
    })
    .then(res => res.json())
    .then(data => {
      let html = '<form method="post" action="/purchases/invoices_suppliers/detail/vincular_orden">';
      html += '<input type="hidden" name="item_id" value="' + itemId + '">';

      if (data.length === 0) {
        html += '<p>No se encontraron órdenes con este ISBN.</p>';
      } else {
        html += '<div class="list-group">';
        data.forEach(orden => {
          const disponibles = orden.quantity - orden.vinculadas;
          const deshabilitado = disponibles <= 0;

          html += '<label class="list-group-item d-flex justify-content-between align-items-center' +
                  (deshabilitado ? ' text-muted' : '') + '">';

          if (!deshabilitado) {
            html += '<input class="form-check-input me-2" type="radio" name="order_id" value="' + orden.order_id + '" required>';
          }

          html += '<div>';
          html += '<strong>Orden #' + orden.order_id + '</strong>';
          html += ' - $' + orden.total + ' - ' + orden.fecha;
          html += '<br><span class="badge badge-info">' + orden.estado + '</span> ';
          html += '<span class="badge badge-secondary">SKU ' + orden.vinculadas + ' / ' + orden.quantity + '</span>';
          if (deshabilitado) {
            html += ' <span class="badge badge-danger">Sin unidades disponibles</span>';
          }
          html += '</div>';

          html += '</label>';
        });
        html += '</div>';
        html += '<button type="submit" class="btn btn-primary mt-3">Vincular</button>';
      }

      html += '</form>';

      // Enviar a revisión
      html += '<div class="text-center mt-3">';
      html += '<form method="post" action="/purchases/invoices_suppliers/detail/vincular_orden">';
      html += '<input type="hidden" name="item_id" value="' + itemId + '">';
      html += '<input type="hidden" name="order_id" value="9999999999">';
      html += '<button type="submit" class="btn btn-warning" onclick="return confirm(\'¿Estás seguro de enviar este ítem a revisión?\')">Enviar a revisión</button>';
      html += '</form>';
      html += '</div>';

      // Agregar a stock
      html += '<div class="text-center mt-2">';
      html += '<form method="post" action="/purchases/invoices_suppliers/detail/vincular_orden">';
      html += '<input type="hidden" name="item_id" value="' + itemId + '">';
      html += '<input type="hidden" name="order_id" value="8888888888">';
      html += '<button type="submit" class="btn btn-success" onclick="return confirm(\'¿Agregar este ítem directamente al stock?\')">Agregar a stock</button>';
      html += '</form>';
      html += '</div>';

      document.getElementById("modalContenido").innerHTML = html;
      showModalOrdenes();
    })
    .catch(() => {
      const cont = document.getElementById("modalContenido");
      if (cont) cont.innerHTML = "<p>Error al buscar órdenes.</p>";
      showModalOrdenes();
    });
  }

  document.querySelectorAll('.vincular-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const itemId = this.getAttribute('data-item-id');
      const isbn = this.getAttribute('data-isbn');
      abrirModal(itemId, isbn);
    });
  });

  // Accesibilidad: mover foco fuera del modal cuando se oculta (BS4 y BS5)
  ['modalCrearRayo','modalOrdenes'].forEach(function(id) {
    var el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('hidden.bs.modal', function() {
      if (document.activeElement && el.contains(document.activeElement)) {
        document.activeElement.blur();
      }
      var opener = document.getElementById('btn-abrir-crear-rayo');
      if (opener) { try { opener.focus(); } catch(e){} }
    });
    el.addEventListener('hide.bs.modal', function() {
      if (document.activeElement && el.contains(document.activeElement)) {
        document.activeElement.blur();
      }
    });
  });

  // Compat: si usás Bootstrap 5, usa data-bs-* en los botones de cerrar
  document.querySelectorAll('[data-dismiss="modal"]').forEach(function(btn){
    if (window.bootstrap && window.bootstrap.Modal) {
      btn.setAttribute('data-bs-dismiss', 'modal');
    }
  });
</script>


{% endblock %}
