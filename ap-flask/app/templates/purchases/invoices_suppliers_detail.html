{% extends "base.html" %}
{% block content %}
<h3>Detalle de Factura: {{ nro_fc }}</h3>

<form method="post" action="{{ url_for('invoices_suppliers_detail.actualizar_tc_factura') }}" class="form-inline mb-3">
  <input type="hidden" name="nro_fc" value="{{ nro_fc }}">
  <label for="tc" class="mr-2"><strong>Tipo de cambio:</strong></label>
  <input type="number" id="tc" name="tc" value="{{ tc or '' }}" step="0.0001"
       class="form-control form-control-sm mr-2" style="width: 120px;">
  <button type="submit" class="btn btn-sm btn-success">Actualizar</button>
</form>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Proveedor</th>
      <th>ISBN</th>
      <th>Importe</th>
      <th>Order ID</th>
      <th>Tipo</th>
      <th class="align-middle">
        Rayo
        <button
          type="button"
          class="btn btn-sm btn-outline-primary ml-1"
          id="btn-abrir-crear-rayo"
          data-toggle="modal"
          data-target="#modalCrearRayo"
          title="Crear en Rayo">
          Crear
        </button>
      </th>
      <th>Acción</th>
    </tr>
  </thead>
  <tbody>
    {% for row in items %}
    <tr>
      <td>{{ row[1].strftime('%d-%m-%Y') if row[1] else '' }}</td>
      <td>{{ row[2] }}</td>
      <td>{{ row[3] }}</td>
      <td>{{ row[4] }}</td>
      <td>
        {% if row[5] %}
          <form method="post" action="{{ url_for('invoices_suppliers_detail.desvincular_orden') }}" style="display:inline;">
            <input type="hidden" name="item_id" value="{{ row[0] }}">
            <span>#{{ row[5] }}</span>
            <button type="submit" class="btn btn-sm btn-outline-danger ml-1" title="Quitar vínculo" onclick="return confirm('¿Desvincular esta orden?')">×</button>
          </form>
        {% else %}
          -
        {% endif %}
      </td>
      <td>{{ row[6] }}</td>
      <td>
        {% if row[8] == 1 %}
          <span class="badge badge-success">Sí</span>
        {% else %}
          <span class="badge badge-secondary">No</span>
        {% endif %}
      </td>
      <td>
        {% if not row[5] %}
          <button class="btn btn-sm btn-info vincular-btn" data-item-id="{{ row[0] }}" data-isbn="{{ row[3]|e }}">Vincular orden</button>
        {% else %}
          —
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Modal: Productos faltantes en Rayo -->
<div class="modal fade" id="modalCrearRayo" tabindex="-1" role="dialog" aria-labelledby="modalCrearRayoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCrearRayoLabel">Productos faltantes en Rayo</h5>
        <button type="button" class="close" data-dismiss="modal" data-bs-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalCrearRayoBody">
        <p class="text-muted mb-0">Cargando…</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Vincular orden (el que fallaba) -->
<div class="modal fade" id="modalOrdenes" tabindex="-1" role="dialog" aria-labelledby="modalOrdenesLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalOrdenesLabel">Vincular orden</h5>
        <button type="button" class="close" data-dismiss="modal" data-bs-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalContenido">
        <p class="text-muted mb-0">Cargando…</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>


  // ===== Modal faltantes (Crear en Rayo): carga + títulos + portada + selección =====
<script>
  // ===== Modal faltantes (Crear en Rayo): carga + títulos + portada + selección + estado =====
  (function () {
    const nroFc = "{{ nro_fc }}";
    const btn = document.getElementById("btn-abrir-crear-rayo");
    const body = document.getElementById("modalCrearRayoBody");

    // --- helper: límite de concurrencia para pedir títulos ---
    function fetchTitlesWithLimit(pairs, limit = 8) {
      let i = 0, active = 0;
      return new Promise(resolve => {
        function next() {
          if (i >= pairs.length && active === 0) return resolve();
          while (active < limit && i < pairs.length) {
            const [cell, code, tr] = pairs[i++];  // cell: <td>, code: isbn/sku_norm, tr: <tr>
            active++;
            fetch(`/purchases/invoices_suppliers/detail/titulo/${encodeURIComponent(code)}`)
              .then(r => r.ok ? r.json() : null)
              .then(d => {
                const title = d && typeof d.title === 'string' && d.title.trim()
                  ? d.title.trim()
                  : '—';
                cell.textContent = title;
                if (tr) tr.dataset.title = (title === '—' ? '' : title);  // guardamos el título
              })
              .catch(() => {
                cell.innerHTML = '<span class="text-muted">—</span>';
                if (tr) tr.dataset.title = '';
              })
              .finally(() => { active--; next(); });
          }
        }
        next();
      });
    }

    // --- portadas con fallback .JPG -> .jpg -> placeholder ---
    function initCovers(rootEl) {
      const NO_IMAGE_URL = 'https://sys.apricor.com.mx/images/np.jpg';
      const imgs = rootEl.querySelectorAll('img[data-ce-cover]');
      imgs.forEach(img => {
        const upper = img.getAttribute('data-upper') || '';
        const lower = img.getAttribute('data-lower') || '';
        img.dataset.state = 'init';
        function handleError() {
          const st = img.dataset.state;
          if (st === 'init' && lower) {
            img.dataset.state = 'tried-lower';
            img.src = lower;
            return;
          }
          img.dataset.state = 'placeholder';
          img.onerror = null;
          img.src = NO_IMAGE_URL;
        }
        img.onerror = handleError;
        if (upper) {
          img.src = upper;
        } else if (lower) {
          img.dataset.state = 'tried-lower';
          img.src = lower;
        } else {
          img.dataset.state = 'placeholder';
          img.onerror = null;
          img.src = NO_IMAGE_URL;
        }
      });
    }

    // === selección múltiple ===
    let selected = new Set(); // guarda ids de fila: "r-0", "r-1", ...

    function getModalEl() {
      return document.getElementById('modalCrearRayo');
    }
    function getFooterEl() {
      return getModalEl().querySelector('.modal-footer');
    }
    function ensureCreateButton() {
      const footer = getFooterEl();
      if (!footer.querySelector('#btn-rayo-crear')) {
        const btnCrear = document.createElement('button');
        btnCrear.type = 'button';
        btnCrear.className = 'btn btn-success';
        btnCrear.id = 'btn-rayo-crear';
        btnCrear.disabled = true;
        btnCrear.textContent = 'Crear';
        btnCrear.addEventListener('click', handleCreateClick);
        footer.appendChild(btnCrear);
      }
    }

    function updateMasterAndCounter(container) {
      const counter = container.querySelector('#sel-counter');
      const master  = container.querySelector('#chk-select-all');
      const totalChecks = container.querySelectorAll('tbody input[type="checkbox"].itm').length;
      const count = selected.size;

      if (counter) counter.textContent = 'Seleccionados: ' + count;

      if (master) {
        if (count === 0) {
          master.indeterminate = false; master.checked = false;
        } else if (count === totalChecks) {
          master.indeterminate = false; master.checked = true;
        } else {
          master.indeterminate = true;
        }
      }

      const btnBottom = document.getElementById('btn-rayo-crear');
      const btnTop    = document.getElementById('btn-rayo-crear-top');
      if (btnBottom) btnBottom.disabled = (count === 0);
      if (btnTop)    btnTop.disabled    = (count === 0);
    }

    function buildCheckboxHeader() {
      return `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="chk-select-all" checked>
            <label class="custom-control-label" for="chk-select-all">Seleccionar todos</label>
          </div>
          <div class="d-flex align-items-center">
            <span id="sel-counter" class="text-muted mr-3">Seleccionados: 0</span>
            <button type="button" class="btn btn-success btn-sm" id="btn-rayo-crear-top">Crear</button>
          </div>
        </div>`;
    }

    function wireCreateButtons() {
      ['btn-rayo-crear', 'btn-rayo-crear-top'].forEach(id => {
        const b = document.getElementById(id);
        if (b) {
          b.onclick = handleCreateClick;
          b.disabled = (selected.size === 0);
        }
      });
    }

    // columna Estado: helpers
    function ensureStatusCell(tr) {
      let cell = tr.querySelector('.col-status');
      if (!cell) {
        cell = document.createElement('td');
        cell.className = 'col-status align-middle';
        tr.appendChild(cell);
      }
      return cell;
    }
    function setRowStatus(tr, kind, codeOrMsg='') {
      const cell = ensureStatusCell(tr);
      if (kind === 'ok') {
        cell.innerHTML = '<span class="text-success" title="Creado correctamente">✔</span>';
      } else if (kind === 'error') {
        const tip = codeOrMsg ? ` (${String(codeOrMsg)})` : '';
        cell.innerHTML = `<span class="text-danger" title="Error${tip}">✘${tip ? ' ' + String(codeOrMsg) : ''}</span>`;
      } else { // neutral/pendiente
        cell.innerHTML = '<span class="text-muted">…</span>';
      }
    }

    function buildRowHtml(it, idx) {
      const raw = String(it.isbn ?? '').trim();
      const digits = raw.replace(/\D+/g, '');
      const prefer = (it.sku_norm && /^\d+$/.test(it.sku_norm)) ? it.sku_norm : digits;

      let coverCell = '<span class="text-muted">—</span>';
      if (/^\d{10,}$/.test(prefer)) {
        const sub = prefer.slice(0, 7);
        const name = prefer.slice(0, -1);
        const upper = `https://www.celesa.com/imagenes/${sub}/${name}.JPG`;
        const lower = `https://www.celesa.com/imagenes/${sub}/${name}.jpg`;
        coverCell = `<img data-ce-cover data-upper="${upper}" data-lower="${lower}" loading="lazy" alt="Portada" style="max-height:64px">`;
      }

      const rowId = `r-${idx}`;
      return `
        <tr id="${rowId}" data-isbn="${raw}" data-code="${prefer}" data-title="">
          <td style="width:40px;">
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input itm" id="chk-${rowId}" data-row-id="${rowId}" checked>
              <label class="custom-control-label" for="chk-${rowId}"></label>
            </div>
          </td>
          <td><code>${raw}</code></td>
          <td class="col-titulo"><span class="text-muted">Buscando…</span></td>
          <td class="col-cover">${coverCell}</td>
          <td class="col-status"></td>
        </tr>`;
    }

    function wireSelectionHandlers(container) {
      const master = container.querySelector('#chk-select-all');
      master.addEventListener('change', () => {
        selected.clear();
        const checks = container.querySelectorAll('tbody input[type="checkbox"].itm');
        checks.forEach(chk => {
          chk.checked = master.checked;
          if (master.checked) selected.add(chk.dataset.rowId);
        });
        updateMasterAndCounter(container);
      });

      container.querySelector('tbody').addEventListener('change', (e) => {
        if (e.target && e.target.matches('input[type="checkbox"].itm')) {
          const id = e.target.dataset.rowId;
          if (e.target.checked) selected.add(id); else selected.delete(id);
          updateMasterAndCounter(container);
        }
      });
    }

    async function handleCreateClick() {
      const rows = Array.from(body.querySelectorAll('tbody tr'));
      const chosen = rows.filter(r => selected.has(r.id));

      const items = chosen.map(r => {
        const sku = (r.dataset.code || '').trim();
        const titulo = (r.dataset.title || '').trim();
        const img = r.querySelector('img[data-ce-cover]');
        const foto = img ? (img.currentSrc || img.src || '').trim() : '';
        return { sku, titulo: titulo || '', foto };
      });

      if (!items.length) return;

      // bloquear UI
      ['btn-rayo-crear','btn-rayo-crear-top'].forEach(id => {
        const b = document.getElementById(id);
        if (b) { b.disabled = true; b.textContent = 'Procesando...'; }
      });

      // poner "pendiente" en estado para los elegidos
      chosen.forEach(tr => setRowStatus(tr, 'pending'));

      try {
        const csrf = document.querySelector('meta[name="csrf-token"]')?.content || '';
        const resp = await fetch(`/purchases/invoices_suppliers/detail/${encodeURIComponent(nroFc)}/rayo/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrf ? { 'X-CSRFToken': csrf } : {})
          },
          body: JSON.stringify({ nro_fc: nroFc, items })
        });

        const clone = resp.clone();
        let data = null, text = null;
        try { data = await resp.json(); } catch { text = await clone.text().catch(() => '(sin cuerpo)'); }

        if (!resp.ok || !data?.ok) {
          console.error('Crear en Rayo - fallo', { status: resp.status, data, text });
          // marcar todos los elegidos como error con el status HTTP
          chosen.forEach(tr => setRowStatus(tr, 'error', resp.status));
          return;
        }

        // --- modo 1: respuesta detallada por ítem ---
        if (Array.isArray(data.results)) {
          data.results.forEach(r => {
            const tr = body.querySelector(`tr[data-code="${(r.sku || '').trim()}"]`);
            if (!tr) return;
            if (r.status === 'ok' || r.status === 'created' || r.status === true) {
              setRowStatus(tr, 'ok');
            } else {
              setRowStatus(tr, 'error', r.code || r.message || 'ERR');
            }
          });
        } else {
          // --- modo 2 (stub actual): marcamos todos los seleccionados como OK ---
          chosen.forEach(tr => setRowStatus(tr, 'ok'));
        }

      } catch (err) {
        console.error('Excepción en fetch:', err);
        chosen.forEach(tr => setRowStatus(tr, 'error', 'NET'));
      } finally {
        // restaurar UI
        ['btn-rayo-crear','btn-rayo-crear-top'].forEach(id => {
          const b = document.getElementById(id);
          if (b) { b.disabled = (selected.size === 0); b.textContent = 'Crear'; }
        });
      }
    }

    // --- abrir modal / cargar faltantes ---
    if (btn) {
      btn.addEventListener("click", function () {
        selected.clear();
        ensureCreateButton();

        body.innerHTML = '<p class="text-muted mb-0">Cargando…</p>';

        fetch(`/purchases/invoices_suppliers/detail/faltantes/${encodeURIComponent(nroFc)}`)
          .then(async (r) => {
            if (!r.ok) {
              const raw = await r.text().catch(() => '(sin detalle)');
              throw new Error(`HTTP ${r.status} al traer faltantes. Respuesta: ${raw}`);
            }
            const rClone = r.clone();
            try {
              return await r.json();
            } catch (e) {
              const raw = await rClone.text().catch(() => '(sin detalle)');
              throw new Error(`No pude parsear JSON de faltantes. Respuesta: ${raw}`);
            }
          })
          .then((payload) => {
            try {
              let total = 0;
              let items = [];

              if (Array.isArray(payload)) {
                items = payload;
                total = items.length;
              } else if (payload && typeof payload === 'object') {
                items = payload.items || payload.data || [];
                total = Number(payload.total ?? payload.count ?? items.length) || 0;
              }

              if (!Array.isArray(items)) items = [];
              if (!total) total = items.length;

              if (!total || items.length === 0) {
                body.innerHTML = `
                  <div class="alert alert-success mb-0">
                    No hay productos faltantes en Rayo para esta factura.
                  </div>`;
                const btnCrear = document.getElementById('btn-rayo-crear');
                if (btnCrear) btnCrear.disabled = true;
                return;
              }

              const rows = items.map((it, idx) => buildRowHtml(it, idx)).join("");

              body.innerHTML = `
                ${buildCheckboxHeader()}
                <div class="table-responsive">
                  <table class="table table-sm table-striped mb-0">
                    <thead>
                      <tr>
                        <th style="width:40px;"></th>
                        <th>ISBN/SKU</th>
                        <th>Título</th>
                        <th>Portada</th>
                        <th>Estado</th>
                      </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>`;

              // wire selección
              wireSelectionHandlers(body);

              // seleccionar todos por defecto
              body.querySelectorAll('tbody input[type="checkbox"].itm').forEach(chk => {
                chk.checked = true;
                selected.add(chk.dataset.rowId);
              });
              updateMasterAndCounter(body);

              // conectar ambos botones "Crear"
              wireCreateButtons();

              // completar títulos con límite de concurrencia
              const tbody = body.querySelector('tbody');
              const pairs = Array.from(tbody.querySelectorAll('tr[data-code]')).map((tr) => {
                const cell = tr.querySelector('.col-titulo');
                const code = tr.getAttribute('data-code') || '';
                return [cell, code, tr];
              });
              fetchTitlesWithLimit(pairs, 8).finally(() => {
                updateMasterAndCounter(body);
              });

              // inicializar portadas
              initCovers(body);
            } catch (e) {
              console.error('Error renderizando items del modal:', e);
              body.innerHTML = `<div class="alert alert-danger mb-0">Error al renderizar los ítems.</div>`;
              const btnCrear = document.getElementById('btn-rayo-crear');
              if (btnCrear) btnCrear.disabled = true;
            }
          })
          .catch((err) => {
            console.error('Fallo al cargar faltantes:', err);
            body.innerHTML = `<div class="alert alert-danger mb-0">Error al cargar los faltantes.</div>`;
            const btnCrear = document.getElementById('btn-rayo-crear');
            if (btnCrear) btnCrear.disabled = true;
          });
      });
    }
  })();
</script>





{% endblock %}
